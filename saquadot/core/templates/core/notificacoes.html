{% extends 'core/base.html' %}
{% block content %}
<div class="container mt-4">
  <h3 class="text-center mb-4">ğŸ”” Minhas NotificaÃ§Ãµes</h3>

  {% if notificacoes_nao_lidas or notificacoes_lidas %}
  <!-- âœ… Bloco Ãºnico de botÃµes corrigido -->
  <div class="text-end mb-3">
    {% if notificacoes_nao_lidas %}
      <a href="{% url 'marcar_todas_lidas' %}" class="btn btn-sm btn-success btn-todas-lidas">ğŸ§¹ Marcar todas como lidas</a>
    {% endif %}
    {% if notificacoes_lidas %}
      <a href="{% url 'apagar_historico' %}" class="btn btn-sm btn-danger btn-apagar-historico ms-2">ğŸ—‘ï¸ Apagar histÃ³rico</a>
    {% endif %}
  </div>

  {% if notificacoes_nao_lidas %}
    <h5 class="text-success mb-3">ğŸ”” Novas notificaÃ§Ãµes</h5>
    <div class="list-group shadow-sm mb-4">
      {% for n in notificacoes_nao_lidas %}
        <div class="list-group-item d-flex justify-content-between align-items-center bg-light border-success">
          <div>
            <span class="badge bg-success me-2">Nova</span>
            <strong>{{ n.mensagem }}</strong>
            <div class="text-muted small">{{ n.data|date:"d/m/Y H:i" }}</div>
          </div>
          <a href="{% url 'marcar_lida' n.id %}" class="btn btn-sm btn-outline-success btn-marcar-lida">Marcar como lida</a>
        </div>
      {% endfor %}
    </div>
  {% endif %}

  {% if notificacoes_lidas %}
    <h5 class="text-secondary mb-3">ğŸ“œ HistÃ³rico</h5>
    <div class="list-group shadow-sm">
      {% for n in notificacoes_lidas %}
        <div class="list-group-item d-flex justify-content-between align-items-center">
          <div>
            <strong>{{ n.mensagem }}</strong>
            <div class="text-muted small">{{ n.data|date:"d/m/Y H:i" }}</div>
          </div>
          <span class="text-success small">âœ”ï¸ Lida</span>
        </div>
      {% endfor %}
    </div>
  {% endif %}
  {% else %}
    <p class="text-center text-muted">Nenhuma notificaÃ§Ã£o por enquanto ğŸ¾</p>
  {% endif %}
</div>

<script>
  document.addEventListener("DOMContentLoaded", function() {

    // --- MARCAR UMA COMO LIDA ---
    document.querySelectorAll(".btn-marcar-lida").forEach(botao => {
      botao.addEventListener("click", function(e) {
        e.preventDefault();
        const url = this.getAttribute("href");
        const item = this.closest(".list-group-item");

        fetch(url, {
          method: 'GET',
          headers: {'X-Requested-With': 'XMLHttpRequest'}
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            item.style.transition = "opacity 0.6s ease";
            item.style.opacity = "0";
            setTimeout(() => item.remove(), 600);
            atualizarContador(data.notificacoes_nao_lidas);
          }
        });
      });
    });

    // --- MARCAR TODAS COMO LIDAS ---
    const btnTodas = document.querySelector(".btn-todas-lidas");
    if (btnTodas) {
      btnTodas.addEventListener("click", function(e) {
        e.preventDefault();
        const url = this.getAttribute("href");

        fetch(url, {
          method: 'GET',
          headers: {'X-Requested-With': 'XMLHttpRequest'}
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            // â— Remove apenas as notificaÃ§Ãµes nÃ£o lidas (bg-light)
            document.querySelectorAll(".list-group-item.bg-light").forEach(item => {
              item.style.transition = "opacity 0.6s ease";
              item.style.opacity = "0";
              setTimeout(() => item.remove(), 600);
            });
            atualizarContador(data.notificacoes_nao_lidas);
          }
        });
      });
    }

    // --- APAGAR HISTÃ“RICO ---
    const btnApagar = document.querySelector(".btn-apagar-historico");
    if (btnApagar) {
      btnApagar.addEventListener("click", function(e) {
        e.preventDefault();
        const url = this.getAttribute("href");

        if (!confirm("Tem certeza que deseja apagar todo o histÃ³rico de notificaÃ§Ãµes lidas?")) {
          return;
        }

        fetch(url, {
          method: 'GET',
          headers: {'X-Requested-With': 'XMLHttpRequest'}
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            document.querySelectorAll(".list-group-item:not(.bg-light)").forEach(item => {
              item.style.transition = "opacity 0.6s ease";
              item.style.opacity = "0";
              setTimeout(() => item.remove(), 600);
            });
            mostrarToast("ğŸ—‘ï¸ HistÃ³rico apagado com sucesso!", "danger");
          }
        });
      });
    }

    // --- Toast visual ---
    function mostrarToast(mensagem, tipo) {
      const container = document.createElement("div");
      container.className = `toast align-items-center text-white bg-${tipo} border-0 position-fixed bottom-0 end-0 m-3 shadow`;
      container.style.zIndex = "1100";
      container.innerHTML = `
        <div class="d-flex">
          <div class="toast-body fw-semibold">${mensagem}</div>
          <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Fechar"></button>
        </div>
      `;
      document.body.appendChild(container);
      const toast = new bootstrap.Toast(container, { delay: 2000 });
      toast.show();
      setTimeout(() => container.remove(), 2500);
    }

    // --- Atualiza contador ğŸ”” ---
    function atualizarContador(qtd) {
      const badge = document.querySelector('.nav-link[href="/notificacoes/"] .badge');
      if (badge) {
        if (qtd > 0) {
          badge.textContent = qtd;
        } else {
          badge.remove();
        }
      }
    }
  });
</script>
{% endblock %}
